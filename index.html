<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Serifu Player</title>
  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    #statusbar-container {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    .statusbar {
      display: inline-block;
      font-size: 16px;
      margin-bottom: 15px;
      padding: 8px;
      border: 1px solid #333;
      border-radius: 5px;
      background-color: #f9f9f9;
      transition: background-color 0.3s ease;
      width: 400px;
    }
    .statusbar.error {
      background-color: #f44336;
      color: #fff;
    }
    #progressbar-container {
      width: 100%;
      height: 5px;
      background-color: #ddd;
      margin-top: 5px;
      border-radius: 3px;
      overflow: hidden;
      cursor: pointer;
    }
    #progressbar {
      height: 100%;
      width: 0%;
      background-color: #6c6;
      transition: width 0.1s linear;
    }
    .row {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    .key {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      width: 50px;
      height: 70px;
      margin: 5px;
      border: 1px solid #333;
      border-radius: 5px;
      background-color: #eee;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.5s ease;
    }
    .key .number {
      font-size: 12px;
    }
    .key .key-char {
      font-size: 24px;
    }
    .key.playing {
      background-color: #6c6;
    }
    .key.played {
      background-color: #cfc;
    }
    .key.error {
      background-color: #f44336;
      color: #fff;
    }
    .spacebar {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 400px;
      height: 50px;
      margin: 20px auto;
      border: 1px solid #333;
      border-radius: 5px;
      background-color: #eee;
      cursor: pointer;
      user-select: none;
      font-size: 18px;
      transition: background-color 0.3s ease;
    }
    .spacebar.playing {
      background-color: #6c6;
    }
    #key-map {
      margin-top: 20px;
      display: inline-block;
      text-align: left;
      font-size: 14px;
      line-height: 1.4;
    }
  </style>
</head>
<body>

<h1>Serifu Player</h1>
<div id="statusbar-container">
  <div id="statusbar" class="statusbar">
    <div id="statusbar-text">Nothing playing.</div>
    <div id="progressbar-container">
      <div id="progressbar"></div>
    </div>
  </div>
</div>
<div id="keys"></div>
<div class="spacebar" id="spacebar">
  <div class="action">Play / Pause</div>
</div>
<div id="key-map-container" style="text-align:center;">
  <div id="key-map"></div>
</div>

<script>
  const keyOrder = '1234567890qwertyuiopasdfghjklzxcvbnm';

  const audioFiles = [
    "1_relationship_can_c.mp3",
    "2_got_it_c.mp3",
    "3_it_sounds_like_c.mp3",
    "4_if_she_c.mp3",
    "5_hello_you_c.mp3",
    "6_here_is_c.mp3",
    "7_out_of_curiosity_c.mp3",
    "8_yes_100_c.mp3",
    "9_i_am_glad_c.mp3",
    "10_i_agree_c.mp3",
    "11_you_are_not_wrong_c.mp3",
    "12_what_if_you_leaned_c.mp3",
    "13_welcome_back_c.mp3",
    "14_nihongo_de_c.mp3",
    "15_sumimasen_c.mp3",
    "16_absolutely_c.mp3",
    "17_thank_you_c.mp3",
    "18_wow_that__c.mp3"
  ];

  let currentAudio = null;
  let currentKey = null;
  let currentFile = null;
  let statusUpdateInterval = null;
  const keyToFileMap = {};

  const keysDiv = document.getElementById('keys');
  const spacebarEl = document.getElementById('spacebar');
  const statusbarEl = document.getElementById('statusbar');

  const rowEnds = ['0', 'p', 'l', 'm'];
  let rowDiv = document.createElement('div');
  rowDiv.className = 'row';
  keysDiv.appendChild(rowDiv);

  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  function handleAudioError(keyChar) {
    const keyEl = document.getElementById(`key-${keyChar}`);
    keyEl.classList.remove('playing');
    keyEl.classList.remove('played');
    keyEl.classList.add('error');

    currentAudio = null;
    currentKey = null;
    currentFile = null;
    updateSpacebarState();
    clearInterval(statusUpdateInterval);
    statusUpdateInterval = null;
    document.getElementById('statusbar-text').textContent = `${keyToFileMap[keyChar]} cannot be found.`;
    statusbarEl.classList.add('error');
    document.getElementById('progressbar').style.width = '0%';
  }

  function updateSpacebarState() {
    if (currentAudio && currentAudio.paused) {
      spacebarEl.classList.add('playing');
    } else {
      spacebarEl.classList.remove('playing');
    }
  }

  function updateStatusBar(finishedKeyChar = null) {
    const statusTextEl = document.getElementById('statusbar-text');
    const progressBarEl = document.getElementById('progressbar');
    statusbarEl.classList.remove('error');

    if (finishedKeyChar) {
      statusTextEl.textContent = `${keyToFileMap[finishedKeyChar]} has finished playing.`;
      progressBarEl.style.width = '0%';
      clearInterval(statusUpdateInterval);
      statusUpdateInterval = null;
    } else if (currentAudio && (currentAudio.duration > 0)) {
      const current = formatTime(currentAudio.currentTime);
      const total = formatTime(currentAudio.duration);
      const prefix = currentAudio.paused ? 'Paused' : 'Playing';
      statusTextEl.textContent = `${prefix}: ${currentFile} (${current} / ${total})`;
      const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
      progressBarEl.style.width = `${progress}%`;
    } else {
      statusTextEl.textContent = 'Nothing playing.';
      progressBarEl.style.width = '0%';
      clearInterval(statusUpdateInterval);
      statusUpdateInterval = null;
    }
  }

  function startAudio(audio, keyChar, fileName, resetPosition = false) {
    const keyEl = document.getElementById(`key-${keyChar}`);
    keyEl.classList.add('playing');
    keyEl.classList.remove('played');
    keyEl.classList.remove('error');

    if (resetPosition) {
      audio.currentTime = 0;
    }

    audio.onerror = () => {
      handleAudioError(keyChar);
    };

    audio.play().then(() => {
      updateSpacebarState();
      updateStatusBar();
      clearInterval(statusUpdateInterval);
      statusUpdateInterval = setInterval(updateStatusBar, 200);
    }).catch(() => {
      handleAudioError(keyChar);
    });

    audio.onended = () => {
      keyEl.classList.remove('playing');
      keyEl.classList.add('played');
      currentAudio = null;
      currentKey = null;
      currentFile = null;
      updateSpacebarState();
      clearInterval(statusUpdateInterval);
      statusUpdateInterval = null;
      updateStatusBar(keyChar);
    };
  }

  function playAudioForKey(keyChar) {
    if (currentAudio && !currentAudio.paused) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
    }

    if (currentKey) {
      const prevKeyEl = document.getElementById(`key-${currentKey}`);
      prevKeyEl.classList.remove('playing');
      prevKeyEl.classList.add('played');
    }

    if (!(keyChar in keyToFileMap)) {
      const keyEl = document.getElementById(`key-${keyChar}`);
      keyEl.classList.remove('playing');
      keyEl.classList.remove('played');
      keyEl.classList.add('error');

      currentAudio = null;
      currentKey = null;
      currentFile = null;
      updateSpacebarState();
      clearInterval(statusUpdateInterval);
      statusUpdateInterval = null;

      document.getElementById('statusbar-text').textContent = `No file assigned to key '${keyChar.toUpperCase()}'`;
      statusbarEl.classList.add('error');
      document.getElementById('progressbar').style.width = '0%';
      return;
    }

    const audioPath = `audio/${keyToFileMap[keyChar]}`;
    const audio = new Audio(audioPath);

    const isRestartingSamePaused = (currentKey === keyChar && currentAudio && currentAudio.paused);

    currentAudio = audio;
    currentKey = keyChar;
    currentFile = keyToFileMap[keyChar];

    startAudio(audio, keyChar, currentFile, isRestartingSamePaused);
  }

  function togglePause() {
    if (!currentAudio) return;
    if (currentAudio.paused) {
      currentAudio.play();
    } else {
      currentAudio.pause();
    }
    updateSpacebarState();
    updateStatusBar();
    if (!statusUpdateInterval) {
      statusUpdateInterval = setInterval(updateStatusBar, 200);
    }
  }

  // Build full keyboard, assign files where available
  for (let i = 0; i < keyOrder.length; i++) {
    const keyChar = keyOrder[i];
    const fileName = audioFiles[i] || null;
    if (fileName) {
      keyToFileMap[keyChar] = fileName;
    }

    const keyEl = document.createElement('div');
    keyEl.className = 'key';
    keyEl.id = `key-${keyChar}`;

    const numberEl = document.createElement('div');
    numberEl.className = 'number';
    numberEl.textContent = i + 1;
    keyEl.appendChild(numberEl);

    const charEl = document.createElement('div');
    charEl.className = 'key-char';
    charEl.textContent = keyChar.toUpperCase();
    keyEl.appendChild(charEl);

    rowDiv.appendChild(keyEl);

    if (rowEnds.includes(keyChar)) {
      rowDiv = document.createElement('div');
      rowDiv.className = 'row';
      keysDiv.appendChild(rowDiv);
    }
  }

  document.addEventListener('keydown', (event) => {
    const keyChar = event.key.toLowerCase();
    if (keyChar === ' ') {
      event.preventDefault();
      togglePause();
      return;
    }
    if (!keyOrder.includes(keyChar)) return;
    playAudioForKey(keyChar);
  });

  keysDiv.addEventListener('click', (event) => {
    let keyEl = event.target.closest('.key');
    if (!keyEl) return;
    const keyChar = keyEl.id.replace('key-', '');
    playAudioForKey(keyChar);
  });

  spacebarEl.addEventListener('click', () => {
    togglePause();
  });

  document.getElementById('progressbar-container').addEventListener('click', (event) => {
    if (!currentAudio || currentAudio.duration <= 0) return;

    const container = event.currentTarget;
    const rect = container.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percentage = clickX / rect.width;
    const newTime = percentage * currentAudio.duration;

    currentAudio.currentTime = newTime;
    updateStatusBar();
  });

  // Build bottom key map
  const keyMapDiv = document.getElementById('key-map');
  const sortedKeys = Object.keys(keyToFileMap).sort((a, b) => keyOrder.indexOf(a) - keyOrder.indexOf(b));
  sortedKeys.forEach((key) => {
    const fileName = keyToFileMap[key];
    const line = document.createElement('div');
    line.textContent = `${key.toUpperCase()} → ${fileName}`;
    keyMapDiv.appendChild(line);
  });
</script>

</body>
</html>
